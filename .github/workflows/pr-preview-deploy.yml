name: PR Preview to EC2

on:
  push:
    branches-ignore:
      - main

jobs:
  continuous-deployment:
    runs-on: ubuntu-latest
    steps:
      # 1) GitHub ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
      - name: Checkout
        uses: actions/checkout@v4

      # 2) ë¸Œëœì¹˜ëª… & í¬íŠ¸ ê³„ì‚°
      - name: Compute branch name & port
        id: meta
        run: |
          RAW="${{ github.ref_name }}"
          SANITIZED="$(echo "$RAW" | tr '[:upper:]' '[:lower:]' | sed 's#[^a-z0-9._-]#-#g')"
          PORT=$(( 5000 + $(echo -n "$SANITIZED" | cksum | awk '{print $1 % 1000}') ))
          echo "name=$SANITIZED" >> $GITHUB_OUTPUT
          echo "port=$PORT" >> $GITHUB_OUTPUT
          echo "[DEBUG] RAW=$RAW"
          echo "[DEBUG] SANITIZED=$SANITIZED"
          echo "[DEBUG] BASE_PORT=$PORT"

      # 2-1) PORT ê°’ ë””ë²„ê·¸ ì¶œë ¥
      - name: Debug meta outputs
        run: |
          echo "[DEBUG] BRANCH=${{ steps.meta.outputs.name }}"
          echo "[DEBUG] PORT=${{ steps.meta.outputs.port }}"

      # 3) ì†ŒìŠ¤ íŒ¨í‚¤ì§•
      - name: Pack source (git archive snapshot)
        run: |
          echo "[DEBUG][GHA] â³ ì†ŒìŠ¤íŒŒì¼ ì••ì¶• ì¤‘..."
          git archive --format=tar HEAD | gzip > app.tar.gz
          echo "[DEBUG][GHA] âœ… ì†ŒìŠ¤íŒŒì¼ ì••ì¶• ì™„ë£Œ"
      # 4) EC2ì— ë°°í¬
      - name: Copy & Deploy on EC2
        env:
          BRANCH: ${{ steps.meta.outputs.name }}
          PORT: ${{ steps.meta.outputs.port }}
          DOMAIN: ${{ vars.DOMAIN }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        shell: bash
        run: |
          echo "[DEBUG][GHA] â³ SSH Key ì„¤ì • ì¤‘..."
          mkdir -p ~/.ssh
          echo "${EC2_SSH_KEY}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          echo "[DEBUG][GHA] â³ SSH Key ì„¤ì • ì™„ë£Œ"

          # ì•± ì•„ì¹´ì´ë¸Œì™€ nginx í…œí”Œë¦¿ì„ ê°™ì´ ì „ì†¡
          echo "[DEBUG][GHA] â³ EC2 ì¸ìŠ¤í„´ìŠ¤ë¡œ ì••ì¶•íŒŒì¼ ë³µì‚¬ ì¤‘..."
          scp -o StrictHostKeyChecking=no app.tar.gz deploy/preview.nginx.tpl ubuntu@"${EC2_HOST}":/tmp/
          echo "[DEBUG][GHA] âœ… EC2 ì¸ìŠ¤í„´ìŠ¤ë¡œ ì••ì¶•íŒŒì¼ ë³µì‚¬ ì™„ë£Œ"

          echo "[DEBUG][GHA] â³ EC2 ì¸ìŠ¤í„´ìŠ¤ì— ì—°ê²° ì¤‘..."

          ssh -o StrictHostKeyChecking=no ubuntu@"${EC2_HOST}" bash -se <<'EOSSH'
          set -euo pipefail

          echo "[DEBUG][GHA] âœ… EC2 ì¸ìŠ¤í„´ìŠ¤ì— ì—°ê²° ì™„ë£Œ"

          # === GitHub Actions ê°’ ì£¼ì… (ì—¬ê¸°ì„œ GH ì»¨í…ìŠ¤íŠ¸ëŠ” ì´ë¯¸ ì¹˜í™˜ëœ ë¬¸ìì—´ì´ ë¨) ===
          BRANCH="${{ steps.meta.outputs.name }}"
          BASE_PORT="${{ steps.meta.outputs.port }}"
          DOMAIN="${{ vars.DOMAIN }}"
          APP_DIR="/var/www/preview/${BRANCH}"

          echo "[DEBUG][EC2] âœ… PREVIEW íŒŒë¼ë¯¸í„° ì¶œë ¥:"
          echo "[INFO] BRANCH=${BRANCH}"
          echo "[INFO] BASE_PORT=${BASE_PORT}"
          echo "[INFO] DOMAIN=${DOMAIN}"
          echo "[INFO] APP_DIR=${APP_DIR}"

          if [ -z "${BASE_PORT}" ]; then
            echo "[FATAL] âœ–ï¸ BASE_PORT is empty"
            exit 1
          fi

          # === ì•± ë””ë ‰í† ë¦¬ & ì½”ë“œ ì „ê°œ ===
          echo "[DEBUG][EC2] â³ ì•± ë””ë ‰í† ë¦¬ ìƒì„± ì¤‘..."
          sudo mkdir -p "${APP_DIR}"
          sudo chown -R ubuntu:ubuntu "${APP_DIR}"
          echo "[DEBUG][EC2] âœ… ì•± ë””ë ‰í† ë¦¬ ìƒì„± ì™„ë£Œ"

          echo "[DEBUG][EC2] â³ ì†ŒìŠ¤ì½”ë“œ ì••ì¶•í•´ì œ ì¤‘..."
          tar -xzf /tmp/app.tar.gz -C "${APP_DIR}"
          rm -f /tmp/app.tar.gz
          echo "[DEBUG][EC2] âœ… ì†ŒìŠ¤ì½”ë“œ ì••ì¶•í•´ì œ ì™„ë£Œ"

          cd "${APP_DIR}"
          echo "[DEBUG][EC2] â³ npm ì„¤ì¹˜ ì¤‘..."
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi
          echo "[DEBUG][EC2] âœ… npm ì„¤ì¹˜ ì™„ë£Œ..."

          echo "[DEBUG][EC2] â³ í”„ë¡œì íŠ¸ ë¹Œë“œì¤‘..."
          rm -rf .next
          NEXT_CACHE_DISABLED=1 npm run build
          echo "[DEBUG][EC2] âœ… í”„ë¡œì íŠ¸ ë¹Œë“œ ì™„ë£Œ"

          # === í¬íŠ¸/PM2 ===
          FINAL_PORT="${BASE_PORT}"
          echo "[DEBUG][EC2] Using port: ${FINAL_PORT}"
          echo "[DEBUG][EC2] Cleaning old processes..."
          pm2 delete "preview-${BRANCH}" || true
          sudo fuser -k ${FINAL_PORT}/tcp || true

          echo "[DEBUG][EC2] â³ PM2 ì‹¤í–‰ ì¤‘..."
          pm2 start "node_modules/.bin/next start -p ${FINAL_PORT}" --name "preview-${BRANCH}"
          pm2 save
          echo "[DEBUG][EC2] âœ… PM2 ì‹¤í–‰ ì™„ë£Œ..."

          # === Nginx vhost ìƒì„±: í…œí”Œë¦¿ + envsubst(ì¹˜í™˜ ë³€ìˆ˜ 'ëª©ë¡' ì œí•œ) ===
          echo "[DEBUG][EC2] â³ Nginx config ìƒì„± ì¤‘..."
          if [ ! -f /tmp/preview.nginx.tpl ]; then
            echo "[FATAL] /tmp/preview.nginx.tpl not found (scp ë‹¨ê³„ í™•ì¸)"
            exit 1
          fi
          echo "[DEBUG][EC2] âœ… Nginx config ìƒì„± ì™„ë£Œ"

          export BRANCH DOMAIN FINAL_PORT
          envsubst "\$BRANCH \$DOMAIN \$FINAL_PORT" < /tmp/preview.nginx.tpl \
            | sudo tee /etc/nginx/conf.d/preview-${BRANCH}.conf >/dev/null

          echo "[DEBUG][EC2] Rendered conf head:"
          sudo sed -n "1,80p" /etc/nginx/conf.d/preview-${BRANCH}.conf || true

          echo "[DEBUG][EC2] â³ Nginx config ë™ì‘ í…ŒìŠ¤íŠ¸ ì¤‘..."
          sudo nginx -t
          if systemctl is-active --quiet nginx; then
            sudo systemctl reload nginx || sudo nginx -s reload
          else
            sudo systemctl start nginx || sudo nginx
          fi
          echo "[DEBUG][EC2] âœ… Nginx config ë™ì‘ í…ŒìŠ¤íŠ¸ ì™„ë£Œ"

          echo "[DEBUG][EC2] Nginx status:"
          (systemctl status nginx --no-pager -l || true) | sed -n '1,20p'

          echo "[DEBUG][EC2] ğŸ” ì›ë³¸ í—¤ë”:"
          curl -sI -H "Host: ${BRANCH}.preview.${DOMAIN}" http://127.0.0.1 \
            | egrep -i "http/|server|cache-control" || true

          # ìƒ‰ìƒ ì •ì˜
          RED="\033[1;31m"
          GREEN="\033[1;32m"
          BLUE="\033[1;34m"
          CYAN="\033[1;36m"
          RESET="\033[0m"

          echo ""
          echo -e "${BLUE}================= ğŸš€ Preview Info =================${RESET}"
          printf "${CYAN}%-15s${RESET} | %s\n" "BRANCH"        "${BRANCH}"
          printf "${CYAN}%-15s${RESET} | %s\n" "Preview URL"   "https://${BRANCH}.preview.${DOMAIN}"
          printf "${CYAN}%-15s${RESET} | %s\n" "Upstream Port" "${FINAL_PORT}"
          echo -e "${BLUE}===================================================${RESET}"
          echo ""
          EOSSH

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: CloudFront Invalidate Cache
        run: |
          echo "[DEBUG] â³ CloudFront ìºì‹œ ë¬´íš¨í™” ì‹œì‘..."
          aws cloudfront create-invalidation --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} --paths "/*"
          echo "[DEBUG] âœ… CloudFront ìºì‹œ ë¬´íš¨í™” ì™„ë£Œ"
