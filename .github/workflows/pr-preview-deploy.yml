name: PR Preview to EC2

on:
  push:
    branches-ignore:
      - main
      - '*-story'

# ë™ì¼ ë¸Œëœì¹˜ì˜ ì´ì „ ë°°í¬ ì‘ì—… ì·¨ì†Œ
concurrency:
  group: preview-deploy-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  continuous-deployment:
    runs-on: ubuntu-latest
    steps:
      # 1) GitHub ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
      - name: Checkout
        uses: actions/checkout@v4

      # 2) ë¸Œëœì¹˜ëª… & í¬íŠ¸ ê³„ì‚°
      - name: Compute branch name & port
        id: meta
        run: |
          RAW="${{ github.ref_name }}"
          SANITIZED="$(echo "$RAW" | tr '[:upper:]' '[:lower:]' | sed 's#[^a-z0-9._-]#-#g')"
          PORT=$(( 5000 + $(echo -n "$SANITIZED" | cksum | awk '{print $1 % 1000}') ))
          echo "name=$SANITIZED" >> $GITHUB_OUTPUT
          echo "port=$PORT" >> $GITHUB_OUTPUT
          echo "[DEBUG][META] âœ… RAW=$RAW"
          echo "[DEBUG][META] âœ… SANITIZED=$SANITIZED"
          echo "[DEBUG][META] âœ… BASE_PORT=$PORT"

      # 2-1) PORT ê°’ ë””ë²„ê·¸ ì¶œë ¥
      - name: Debug meta outputs
        run: |
          echo "[DEBUG][META] âœ… BRANCH=${{ steps.meta.outputs.name }}"
          echo "[DEBUG][META] âœ… PORT=${{ steps.meta.outputs.port }}"

      # 3) Node.js í™˜ê²½ ì„¤ì •
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      # 4) ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        run: |
          echo "[DEBUG][GHA] âŒ› npm ì˜ì¡´ì„± ì„¤ì¹˜ ì§„í–‰ ì¤‘..."
          npm ci
          echo "[DEBUG][GHA] âœ… npm ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"

      # 5) í”„ë¡œì íŠ¸ ë¹Œë“œ
      - name: Build project
        env:
          NEXT_PUBLIC_API_BASE_URL: ${{ vars.NEXT_PUBLIC_API_BASE_URL }}
          NEXT_PUBLIC_JS_KEY_KAKAO: ${{ secrets.NEXT_PUBLIC_JS_KEY_KAKAO }}
        run: |
          echo "[DEBUG][GHA] âŒ› í”„ë¡œì íŠ¸ ë¹Œë“œ ì§„í–‰ ì¤‘..."
          rm -rf .next
          NEXT_CACHE_DISABLED=1 npm run build
          echo "[DEBUG][GHA] âœ… í”„ë¡œì íŠ¸ ë¹Œë“œ ì™„ë£Œ"

      # 6) ë°°í¬ìš© íŒŒì¼ íŒ¨í‚¤ì§•
      - name: Package deployment files
        run: |
          echo "[DEBUG][GHA] âŒ› ë°°í¬ìš© íŒŒì¼ íŒ¨í‚¤ì§• ì§„í–‰ ì¤‘..."

          # ê°œë°œ ì˜ì¡´ì„±ë§Œ ì œê±° (ì™„ì „íˆ ì¬ì„¤ì¹˜í•˜ì§€ ì•Šê³ )
          echo "[DEBUG][GHA] âŒ› ê°œë°œ ì˜ì¡´ì„± ì œê±° ì§„í–‰ ì¤‘..."
          BEFORE_SIZE=$(du -sh node_modules | cut -f1)
          echo "[DEBUG][GHA] ğŸ” BEFORE prune: $BEFORE_SIZE"
          npm prune --omit=dev
          AFTER_SIZE=$(du -sh node_modules | cut -f1)
          echo "[DEBUG][GHA] ğŸ” AFTER prune: $AFTER_SIZE"
          echo "[DEBUG][GHA] âœ… ê°œë°œ ì˜ì¡´ì„± ì œê±° ì™„ë£Œ"

          # ë°°í¬ì— í•„ìš”í•œ íŒŒì¼ë“¤ë§Œ ì„ ë³„í•´ì„œ íŒ¨í‚¤ì§•
          mkdir -p deploy-package

          # Next.js ë¹Œë“œ ê²°ê³¼ë¬¼
          cp -r .next deploy-package/
          cp -r public deploy-package/ 2>/dev/null || true

          # ëŸ°íƒ€ì„ì— í•„ìš”í•œ íŒŒì¼ë“¤
          cp package.json deploy-package/
          cp package-lock.json deploy-package/ 2>/dev/null || true
          cp next.config.* deploy-package/ 2>/dev/null || true

          # ì¶”ê°€: config í´ë” ë³µì‚¬
          cp -r config deploy-package/ 2>/dev/null || true

          # ìµœì í™”ëœ í”„ë¡œë•ì…˜ ì˜ì¡´ì„±
          cp -r node_modules deploy-package/
          echo "[DEBUG][GHA] ğŸ” Copied node_modules size: $(du -sh deploy-package/node_modules | cut -f1)"
          PACKAGE_SIZE=$(du -sh deploy-package | cut -f1)

          RED="\033[1;31m"
          GREEN="\033[1;32m"
          BLUE="\033[1;34m"
          CYAN="\033[1;36m"
          RESET="\033[0m"

          echo ""
          echo -e "${CYAN}================== ğŸ“ Deploy package info ==================${RESET}"
          printf "${CYAN}%-30s${RESET} | %s\n" "node_modules" "$(du -sh deploy-package/node_modules | cut -f1)"
          printf "${CYAN}%-30s${RESET} | %s\n" ".next" "$(du -sh deploy-package/.next | cut -f1)"
          printf "${CYAN}%-30s${RESET} | %s\n" "public" "$(du -sh deploy-package/public | cut -f1)"
          printf "${CYAN}%-30s${RESET} | %s\n" "config" "$(du -sh deploy-package/config | cut -f1)"
          printf "${CYAN}%-30s${RESET} | %s\n" "other files" "$(du -sh deploy-package/*.json deploy-package/*.* 2>/dev/null | awk '{sum+=$1} END {print sum "K"}' || echo "N/A")"
          echo -e "${BLUE}=============================================================${RESET}"
          echo ""
          # ì••ì¶•
          cd deploy-package
          echo "[DEBUG][GHA] âŒ› ê³ ì••ì¶• ì§„í–‰ ì¤‘..."
          tar -czf ../app-built.tar.gz --exclude-from=<(echo -e "node_modules/*/.cache\nnode_modules/*/coverage\nnode_modules/*/.nyc_output") .
          cd ..
          rm -rf deploy-package

          FINAL_SIZE=$(du -sh app-built.tar.gz | cut -f1)

          echo ""
          echo -e "${BLUE}===================== ğŸ“¦ Packaging Info ====================${RESET}"
          printf "${CYAN}%-30s${RESET} | %s\n" "Full node_modules size" "$BEFORE_SIZE"
          printf "${CYAN}%-30s${RESET} | %s\n" "Production node_modules size" "$AFTER_SIZE"
          printf "${CYAN}%-30s${RESET} | %s\n" "Deploy package size" "$PACKAGE_SIZE"
          printf "${CYAN}%-30s${RESET} | %s\n" "Final compressed size" "$FINAL_SIZE"
          echo -e "${BLUE}=============================================================${RESET}"
          echo ""
          echo "[DEBUG][GHA] âœ… ë°°í¬ìš© íŒŒì¼ íŒ¨í‚¤ì§• ì™„ë£Œ"

      # 7) EC2ì— ë°°í¬
      - name: Deploy to EC2
        id: deploy
        env:
          BRANCH: ${{ steps.meta.outputs.name }}
          PORT: ${{ steps.meta.outputs.port }}
          DOMAIN: ${{ vars.DOMAIN }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        shell: bash
        run: |
          echo "[DEBUG][GHA] âŒ› SSH Key ì„¤ì • ì§„í–‰ ì¤‘..."
          mkdir -p ~/.ssh
          echo "${EC2_SSH_KEY}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          echo "[DEBUG][GHA] âœ… SSH Key ì„¤ì • ì™„ë£Œ"

          echo "[DEBUG][GHA] âŒ› EC2 ì¸ìŠ¤í„´ìŠ¤ë¡œ íŒŒì¼ ë³µì‚¬ ì§„í–‰ ì¤‘..."
          echo "[DEBUG][GHA] ğŸ” ë³µì‚¬ ì „ EC2 ë©”ëª¨ë¦¬: $(ssh -o StrictHostKeyChecking=no ubuntu@"${EC2_HOST}" "free -h | grep '^Mem:' | awk '{print \$3 \"/\" \$2}'")"

          # EC2ì—ì„œ ë©”ëª¨ë¦¬ ëª¨ë‹ˆí„°ë§ ì‹œì‘ (ì‹¤ì‹œê°„ ì¶œë ¥)
          ssh -o StrictHostKeyChecking=no ubuntu@"${EC2_HOST}" "
          (while true; do
            CURRENT_MEM=\$(free -m | grep '^Mem:' | awk '{print \$3}')
            TOTAL_MEM=\$(free -m | grep '^Mem:' | awk '{print \$2}')
            PERCENT=\$(echo \"scale=1; \$CURRENT_MEM * 100 / \$TOTAL_MEM\" | bc -l)
            echo \"[MONITOR] \$(date '+%H:%M:%S') - ë©”ëª¨ë¦¬: \${CURRENT_MEM}MB/\${TOTAL_MEM}MB (\${PERCENT}%)\"
            sleep 1
          done) &
          echo \$! > /tmp/monitor.pid
          " &

          # íŒŒì¼ ë³µì‚¬ ì‹¤í–‰
          scp -o StrictHostKeyChecking=no app-built.tar.gz deploy/preview.nginx.tpl ubuntu@"${EC2_HOST}":/tmp/

          # ëª¨ë‹ˆí„°ë§ ì¢…ë£Œ
          ssh -o StrictHostKeyChecking=no ubuntu@"${EC2_HOST}" "
          sleep 2
          kill \$(cat /tmp/monitor.pid) 2>/dev/null || true
          rm -f /tmp/monitor.pid
          "

          echo "[DEBUG][GHA] ğŸ” ë³µì‚¬ í›„ EC2 ë©”ëª¨ë¦¬: $(ssh -o StrictHostKeyChecking=no ubuntu@"${EC2_HOST}" "free -h | grep '^Mem:' | awk '{print \$3 \"/\" \$2}'")"
          echo "[DEBUG][GHA] âœ… EC2 ì¸ìŠ¤í„´ìŠ¤ë¡œ íŒŒì¼ ë³µì‚¬ ì™„ë£Œ"

          echo "[DEBUG][GHA] âŒ› EC2 ì¸ìŠ¤í„´ìŠ¤ ì—°ê²° ì§„í–‰ ì¤‘..."
          ssh -o StrictHostKeyChecking=no ubuntu@"${EC2_HOST}" bash -se <<'EOSSH'
          set -euo pipefail

          echo "[DEBUG][EC2] âœ… EC2 ì¸ìŠ¤í„´ìŠ¤ ì—°ê²° ì™„ë£Œ"

          BRANCH="${{ steps.meta.outputs.name }}"
          BASE_PORT="${{ steps.meta.outputs.port }}"
          DOMAIN="${{ vars.DOMAIN }}"
          APP_DIR="/var/www/preview/${BRANCH}"

          echo "[DEBUG][EC2] âœ… PREVIEW íŒŒë¼ë¯¸í„°:"
          echo "[INFO] BRANCH=${BRANCH}"
          echo "[INFO] BASE_PORT=${BASE_PORT}"
          echo "[INFO] DOMAIN=${DOMAIN}"
          echo "[INFO] APP_DIR=${APP_DIR}"

          if [ -z "${BASE_PORT}" ]; then
            echo "[FATAL] âœ–ï¸ BASE_PORT is empty"
            exit 1
          fi

          FINAL_PORT="${BASE_PORT}"
          echo "[DEBUG][EC2] âŒ› ì´ì „ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬ ì§„í–‰ ì¤‘..."
          pm2 delete "preview-${BRANCH}" || true
          sudo fuser -k ${FINAL_PORT}/tcp || true
          echo "[DEBUG][EC2] âœ… ì´ì „ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬ ì™„ë£Œ"

          echo "[DEBUG][EC2] âŒ› ì•± ë””ë ‰í† ë¦¬ ì •ë¦¬ ë° ìƒì„± ì§„í–‰ ì¤‘..."
          echo "[DEBUG][EC2] ğŸ” ì •ë¦¬ ì „ ë©”ëª¨ë¦¬: $(free -h | grep '^Mem:' | awk '{print $3 "/" $2}')"
          sudo rm -rf "${APP_DIR}"
          sudo mkdir -p "${APP_DIR}"
          sudo chown -R ubuntu:ubuntu "${APP_DIR}"
          echo "[DEBUG][EC2] âœ… ì•± ë””ë ‰í† ë¦¬ ì •ë¦¬ ë° ìƒì„± ì™„ë£Œ"

          echo "[DEBUG][EC2] âŒ› ë¹Œë“œëœ íŒŒì¼ ì••ì¶• í•´ì œ ì§„í–‰ ì¤‘..."
          echo "[DEBUG][EC2] ğŸ” ì••ì¶• í•´ì œ ì „ ë©”ëª¨ë¦¬: $(free -h | grep '^Mem:' | awk '{print $3 "/" $2}')"

          # EC2ì—ì„œ ì••ì¶• í•´ì œ ì¤‘ ë©”ëª¨ë¦¬ ëª¨ë‹ˆí„°ë§
          (while true; do
            CURRENT_MEM=$(free -m | grep '^Mem:' | awk '{print $3}')
            TOTAL_MEM=$(free -m | grep '^Mem:' | awk '{print $2}')
            PERCENT=$(echo "scale=1; $CURRENT_MEM * 100 / $TOTAL_MEM" | bc -l)
            echo "[MONITOR] $(date '+%H:%M:%S') - ë©”ëª¨ë¦¬: ${CURRENT_MEM}MB/${TOTAL_MEM}MB (${PERCENT}%)"
            sleep 1
          done) &
          MONITOR_PID=$!

          tar -xzf /tmp/app-built.tar.gz -C "${APP_DIR}"
          echo "[DEBUG][EC2] ğŸ” ì••ì¶• í•´ì œ ì§í›„ breakdown:"
          cd "${APP_DIR}"
          du -sh node_modules .next public config *.json 2>/dev/null
          rm -f /tmp/app-built.tar.gz

          # ëª¨ë‹ˆí„°ë§ ì¢…ë£Œ ì „ì— ì ì‹œ ëŒ€ê¸°
          sleep 3
          kill $MONITOR_PID 2>/dev/null || true

          echo "[DEBUG][EC2] ğŸ” ì••ì¶• í•´ì œ í›„ ë©”ëª¨ë¦¬: $(free -h | grep '^Mem:' | awk '{print $3 "/" $2}')"
          echo "[DEBUG][EC2] âœ… ë¹Œë“œëœ íŒŒì¼ ì••ì¶• í•´ì œ ì™„ë£Œ"

          cd "${APP_DIR}"

          echo "[DEBUG][EC2] âŒ› PM2 ì‹¤í–‰ ì§„í–‰ ì¤‘..."
          pm2 start "node_modules/.bin/next start -p ${FINAL_PORT}" --name "preview-${BRANCH}"
          pm2 save
          echo "[DEBUG][EC2] âœ… PM2 ì‹¤í–‰ ì™„ë£Œ"

          echo "[DEBUG][EC2] âŒ› Nginx ì„¤ì • ìƒì„± ì§„í–‰ ì¤‘..."
          if [ ! -f /tmp/preview.nginx.tpl ]; then
            echo "[FATAL] /tmp/preview.nginx.tpl not found"
            exit 1
          fi
          export BRANCH DOMAIN FINAL_PORT
          envsubst "\$BRANCH \$DOMAIN \$FINAL_PORT" < /tmp/preview.nginx.tpl \
            | sudo tee /etc/nginx/conf.d/preview-${BRANCH}.conf >/dev/null
          echo "[DEBUG][EC2] âœ… Nginx ì„¤ì • ìƒì„± ì™„ë£Œ"

          echo "[DEBUG][EC2] ğŸ” Rendered conf head:"
          sudo sed -n "1,80p" /etc/nginx/conf.d/preview-${BRANCH}.conf || true

          echo "[DEBUG][EC2] âŒ› Nginx ì„¤ì • í…ŒìŠ¤íŠ¸ ë° ì¬ì‹œì‘ ì§„í–‰ ì¤‘..."
          sudo nginx -t
          if systemctl is-active --quiet nginx; then
            sudo systemctl reload nginx || sudo nginx -s reload
          else
            sudo systemctl start nginx || sudo nginx
          fi
          echo "[DEBUG][EC2] âœ… Nginx ì„¤ì • í…ŒìŠ¤íŠ¸ ë° ì¬ì‹œì‘ ì™„ë£Œ"

          echo "[DEBUG][EC2] ğŸ” í˜„ì¬ Nginx ìƒíƒœ í™•ì¸..."
          (systemctl status nginx --no-pager -l || true) | sed -n '1,20p'

          echo "[DEBUG][EC2] ğŸ” ì›ë³¸ í—¤ë” í™•ì¸..."
          curl -sI -H "Host: ${BRANCH}.preview.${DOMAIN}" http://127.0.0.1 \
            | egrep -i "http/|server|cache-control" || true

          RED="\033[1;31m"
          GREEN="\033[1;32m"
          BLUE="\033[1;34m"
          CYAN="\033[1;36m"
          RESET="\033[0m"

          echo ""
          echo -e "${BLUE}===================== ğŸ“Š EC2 ë¦¬ì†ŒìŠ¤ í˜„í™© =====================${RESET}"
          MEM_INFO=$(free -m | awk '/^Mem:/ {printf "%dM/%dM (%d%%)", $3, $2, ($3/$2)*100}')
          DISK_INFO=$(df -BG / | awk 'NR==2 {gsub("G","",$2); gsub("G","",$3); gsub("%","",$5); printf "%dG/%dG (%d%%)", $3, $2, $5}')
          printf "${CYAN}%-15s${RESET} | %s\n" "Memory" "$MEM_INFO"
          printf "${CYAN}%-15s${RESET} | %s\n" "Disk" "$DISK_INFO"
          echo -e "${BLUE}=============================================================${RESET}"
          echo ""

          EOSSH

          echo "preview_url=https://${BRANCH}.preview.${DOMAIN}" >> $GITHUB_OUTPUT
          echo "branch=${BRANCH}" >> $GITHUB_OUTPUT
          echo "port=${FINAL_PORT}" >> $GITHUB_OUTPUT

      # 8) Preview Info ì¶œë ¥
      - name: Print Preview Info
        run: |
          RED="\033[1;31m"
          GREEN="\033[1;32m"
          BLUE="\033[1;34m"
          CYAN="\033[1;36m"
          RESET="\033[0m"

          echo ""
          echo -e "${BLUE}====================== ğŸš€ Preview Info ======================${RESET}"
          printf "${CYAN}%-15s${RESET} | %s\n" "BRANCH"        "${{ steps.deploy.outputs.branch }}"
          printf "${CYAN}%-15s${RESET} | %s\n" "Preview URL"   "${{ steps.deploy.outputs.preview_url }}"
          printf "${CYAN}%-15s${RESET} | %s\n" "Upstream Port" "${{ steps.meta.outputs.port }}"
          echo -e "${BLUE}=============================================================${RESET}"
          echo ""
