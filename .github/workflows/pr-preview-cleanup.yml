name: PR Preview Cleanup

on:
  pull_request:
    types: [closed]

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Compute branch name
        id: meta
        run: |
          RAW="${{ github.event.pull_request.head.ref }}"
          SANITIZED="$(echo "$RAW" | tr '[:upper:]' '[:lower:]' | sed 's#[^a-z0-9._-]#-#g')"
          echo "name=$SANITIZED" >> $GITHUB_OUTPUT

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Cleanup Preview Environment on EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          DOMAIN: ${{ vars.DOMAIN }}
          BRANCH: ${{ steps.meta.outputs.name }}
        run: |
          echo "[DEBUG][GHA] â³ EC2 ì ‘ì† í›„ preview ì •ë¦¬ ì‘ì—… ì‹¤í–‰..."
          ssh -o StrictHostKeyChecking=no ubuntu@"${EC2_HOST}" bash -se <<'EOSSH'
          set -euo pipefail
          BRANCH="${BRANCH}"
          APP_DIR="/var/www/preview/${BRANCH}"
          CONF_FILE="/etc/nginx/conf.d/preview-${BRANCH}.conf"

          echo "[INFO] ğŸ§¹ Cleaning preview for branch: ${BRANCH}"

          # 1) PM2 í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
          echo "[DEBUG][EC2] â³ PM2 í”„ë¡œì„¸ìŠ¤ ì‚­ì œ ì¤‘...: preview-${BRANCH}"
          pm2 delete "preview-${BRANCH}" || true
          pm2 save
          echo "[DEBUG][EC2] âœ… PM2 í”„ë¡œì„¸ìŠ¤ ì‚­ì œ ì™„ë£Œ"

          # 2) ë””ë ‰í† ë¦¬ ì •ë¦¬
          if [ -d "$APP_DIR" ]; then
            echo "[DEBUG][EC2] â³ ì•± ë””ë ‰í† ë¦¬ ì‚­ì œì¤‘...: $APP_DIR"
            sudo rm -rf "$APP_DIR"
            echo "[DEBUG][EC2] âœ… ì•± ë””ë ‰í† ë¦¬ ì‚­ì œ ì™„ë£Œ"
          fi

          # 3) Nginx ì„¤ì • ì œê±°
          if [ -f "$CONF_FILE" ]; then
            echo "[DEBUG][EC2] â³ Nginx conf ì‚­ì œì¤‘...: $CONF_FILE"
            sudo rm -f "$CONF_FILE"
            sudo nginx -t
            sudo systemctl reload nginx || sudo nginx -s reload
            echo "[DEBUG][EC2] âœ… Nginx conf ì‚­ì œ ì™„ë£Œ"
          fi

          echo "[INFO] âœ… Cleanup finished for branch: ${BRANCH}"
          EOSSH
