name: PR Preview Cleanup

on:
  pull_request:
    types: [closed]

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Cleanup Preview Environment on EC2
        run: |
          echo "[DEBUG][GHA] â³ EC2 ì ‘ì† í›„ preview ì •ë¦¬ ì‘ì—… ì‹¤í–‰..."
          ssh -o StrictHostKeyChecking=no ubuntu@"${{ secrets.EC2_HOST }}" bash -se <<'EOSSH'
          set -euo pipefail

          # === GitHub Actions ê°’ ì£¼ì… (ì—¬ê¸°ì„œ GH ì»¨í…ìŠ¤íŠ¸ëŠ” ì´ë¯¸ ì¹˜í™˜ëœ ë¬¸ìì—´ì´ ë¨) ===
          BRANCH="${{ github.event.pull_request.head.ref }}"
          SANITIZED="$(echo "$BRANCH" | tr '[:upper:]' '[:lower:]' | sed 's#[^a-z0-9._-]#-#g')"
          DOMAIN="${{ vars.DOMAIN }}"
          APP_DIR="/var/www/preview/${SANITIZED}"
          CONF_FILE="/etc/nginx/conf.d/preview-${SANITIZED}.conf"

          echo "[INFO] ğŸ§¹ Cleaning preview for branch: ${SANITIZED}"

          # 1) PM2 í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
          echo "[DEBUG][EC2] â³ PM2 í”„ë¡œì„¸ìŠ¤ ì‚­ì œ ì¤‘...: preview-${SANITIZED}"
          pm2 delete "preview-${SANITIZED}" || true
          pm2 save
          echo "[DEBUG][EC2] âœ… PM2 í”„ë¡œì„¸ìŠ¤ ì‚­ì œ ì™„ë£Œ"

          # 2) ë””ë ‰í† ë¦¬ ì •ë¦¬
          if [ -d "$APP_DIR" ]; then
            echo "[DEBUG][EC2] â³ ì•± ë””ë ‰í† ë¦¬ ì‚­ì œì¤‘...: $APP_DIR"
            sudo rm -rf "$APP_DIR"
            echo "[DEBUG][EC2] âœ… ì•± ë””ë ‰í† ë¦¬ ì‚­ì œ ì™„ë£Œ"
          fi

          # 3) Nginx ì„¤ì • ì œê±°
          if [ -f "$CONF_FILE" ]; then
            echo "[DEBUG][EC2] â³ Nginx conf ì‚­ì œì¤‘...: $CONF_FILE"
            sudo rm -f "$CONF_FILE"
            sudo nginx -t
            sudo systemctl reload nginx || sudo nginx -s reload
            echo "[DEBUG][EC2] âœ… Nginx conf ì‚­ì œ ì™„ë£Œ"
          fi

          echo "[INFO] âœ… Cleanup finished for branch: ${SANITIZED}"
          EOSSH
